<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map with NetMonster CSV Data</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
        }
        #map {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        var map = L.map('map').setView([39.3999, -8.2245], 7);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Função para carregar pontos do CSV
        function loadCSVPoints(csvData, operatorName) {
            Papa.parse(csvData, {
                header: true,
                dynamicTyping: true,
                complete: function (result) {
                    console.log('Parsed CSV Data:', result.data);

                    // Iterar sobre os dados do CSV e adicionar marcadores ao mapa
                    result.data.forEach(function (point) {
                        console.log('Point:', point);

                        // Procurar colunas de latitude e longitude dinamicamente
                        var latColumnName = findColumnBySubstring(point, 'Lat');
                        var lonColumnName = findColumnBySubstring(point, 'Lon');

                        // Verificar se as colunas foram encontradas
                        if (latColumnName && lonColumnName) {
                            var markerContent = "<b>" + operatorName + "</b><br>" +
                                                "Location: " + point.Location;

                            // Adicionar informações específicas da tecnologia
                            switch (point[Object.keys(point)[0]]) {
                                case '2G':
                                    markerContent += "<br>ARFCN: " + point.ARFCN;
                                    break;
                                case '3G':
                                    markerContent += "<br>UARFCN: " + point.UARFCN;
                                    break;
                                case '4G':
                                    markerContent += "<br>EARFCN: " + point.EARFCN;
                                    break;
                                case '5G':
                                    markerContent += "<br>ARFCN: " + point.ARFCN;
                                    break;
                                case 'CD':
                                    // Handle CDMA-specific columns
                                    markerContent += "<br>CDMA Info: " + point.XX1 + " " + point.NID + " " + point.BID;
                                    break;
                                default:
                                    console.error('Invalid technology type:', point[Object.keys(point)[0]]);
                                    return; // Skip invalid entry
                            }

                            L.marker([point[latColumnName], point[lonColumnName]])
                                .addTo(map)
                                .bindPopup(markerContent);
                        } else {
                            console.error('Latitude or Longitude column not found for point:', point);
                        }
                    });
                }
            });
        }

        // Função para encontrar uma coluna por substring no nome
        function findColumnBySubstring(data, substring) {
            return Object.keys(data).find(function (key) {
                return key.toLowerCase().includes(substring.toLowerCase());
            });
        }

        // URLs dos arquivos CSV
        var csvUrls = [
            'http://localhost:8080/database/2g_data.ntm',
            'http://localhost:8080/database/3g_data.ntm',
            'http://localhost:8080/database/4g_data.ntm',
            'http://localhost:8080/database/5g_data.ntm',
            'http://localhost:8080/database/cdma_data.ntm'
        ];

        // Nomes das operadoras correspondentes aos arquivos CSV
        var operatorNames = [
            '2G Operator',
            '3G Operator',
            '4G Operator',
            '5G Operator',
            'CDMA Operator'
        ];

        // Carregar dados de cada arquivo CSV
        csvUrls.forEach(function (url, index) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    loadCSVPoints(xhr.responseText, operatorNames[index]);
                }
            };
            xhr.open('GET', url, true);
            xhr.send();
        });
    </script>
</body>
</html>
